# Terraform & Ansible Tutorial: Provisioning AWS Resources and Installing Minecraft Server

## Background

In this tutorial, we will use **Terraform** and **Ansible** to provision an **AWS EC2 instance** and set up a **Minecraft server**. This server will automatically restart when the instance reboots. Specifically, we will:

- Provision an EC2 instance with Terraform.
- Use Ansible to install the Minecraft server on the instance.
- Ensure that the Minecraft server restarts automatically after reboots.

We'll break it down into smaller tasks:
1. **Provision AWS Compute Resources with Terraform**.
2. **Configure Networking on AWS**.
3. **Install and Configure Minecraft Server** using Ansible.
4. **Ensure that the Minecraft Server restarts on reboot**.
5. **Test the setup**.
## Requirements

Before we begin, the user must have the following tools and configurations:
### Tools:
- **Terraform** (v1.0 or above)
- **Ansible** (v2.9 or above)
- **AWS CLI** (v2.0 or above)
### AWS Configuration:
- **AWS Account**: You'll need an AWS account with sufficient privileges to create EC2 instances, security groups, VPCs, and IAM roles.
- **IAM Credentials**: Configure AWS CLI with credentials (Access Key and Secret Key) using `aws configure`.
### Environment Variables:
- **AWS Access Key and Secret Key**: These are required for Terraform and AWS CLI to authenticate with AWS.

```
export AWS_ACCESS_KEY_ID="YOUR_ACCESS_KEY"
export AWS_SECRET_ACCESS_KEY="YOUR_SECRET_KEY"
export AWS_DEFAULT_REGION="us-west-2"
```
### System Dependencies:
- **Python 3.x** for Ansible to run playbooks.
- **Ansible (latest)**
- **Terraform (latest)** 
- **Boto3** (Python AWS SDK) should be installed for Ansible to interact with AWS.

```
pip install boto3
```

## Diagram
![diagram](https://raw.githubusercontent.com/digitaldisarray/sysadmin-final/refs/heads/main/diagram.svg)


## Step-by-Step Commands

### 1. Install Terraform and Ansible

Before starting, ensure that Terraform, Ansible, and AWS CLI are installed.

- **Terraform**: Follow the installation guide at [Terraform Install](https://www.terraform.io/downloads).
- **Ansible**: Install Ansible using `pip install ansible`
- **AWS CLI**: Install AWS CLI v2 by following [AWS CLI Installation Guide](https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html).
### 2. Initialize Terraform and Apply the Configuration
Run the following commands to initialize Terraform and apply the configuration:
```
terraform init
terraform plan
terraform apply
```

Terraform will prompt you for confirmation before creating the resources. After approval, it will provision the EC2 instance, VPC, subnet, and security group.

You also need to export the ssh key generated by terraform
```
terraform output private_key_pem > minecraft_key.pem
chmod 600 minecraft_key.pem 
```
### 3. Configure Inventory for Ansible
Create an `inventory` file with your EC2 instance IP:
```
[minecraft]
<EC2_INSTANCE_IP> ansible_ssh_user=ec2-user ansible_ssh_private_key_file=minecraft-key.pem
```

Replace `<EC2_INSTANCE_IP>` with the output IP from Terraform and the private key path for SSH access.

### 4. Run the Ansible Playbook

Execute the Ansible playbook:
```
ansible-playbook -i inventory minecraft.yml
```

This will install the Minecraft server and create a systemd service to ensure it restarts automatically.

### 5. Access the Minecraft Server

1. Open your Minecraft client.
2. Connect to the server using the EC2 instance public IP address and port `25565`.

For example:

<EC2_INSTANCE_IP>:25565


### 6. Testing Auto-Restart

To test if the Minecraft server restarts after rebooting the EC2 instance, simply restart the instance:
```
aws ec2 reboot-instances --instance-ids <INSTANCE_ID>
```

After the instance reboots, the Minecraft server should automatically start.

## Sources
- [Terraform Documentation](https://www.terraform.io/docs)
- [Ansible Documentation](https://docs.ansible.com/)
- [AWS EC2 Documentation](https://docs.aws.amazon.com/ec2/)
- [Minecraft Server Installation Guide](https://minecraft.gamepedia.com/Tutorials/Setting_up_a_server)
